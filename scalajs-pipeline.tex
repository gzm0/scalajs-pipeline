\documentclass{beamer}

\usepackage[utf8]{inputenc}

\usepackage{alltt}
\usepackage{listings}
\usepackage{xcolor}

\lstdefinelanguage{scala}{
  morekeywords={abstract,case,catch,class,def,%
    do,else,extends,false,final,finally,%
    for,if,implicit,import,match,mixin,%
    new,null,object,override,package,%
    private,protected,requires,return,sealed,%
    super,this,throw,trait,true,try,%
    type,val,var,while,with,yield},
  otherkeywords={=>,<-,<\%,<:,>:,\#},
  sensitive=true,
  morecomment=[l]{//},
  morecomment=[n]{/*}{*/},
  morestring=[b]",
  morestring=[b]',
  morestring=[b]"""
}


%\usepackage{amssymb}
%\usepackage[overlay,absolute]{textpos}
%\usepackage[normalem]{ulem}

\usepackage{tikz}
\usepackage{tkz-berge}

%% Colors for source highlighting
\definecolor{scKW}  {HTML}{AA37F2}
\definecolor{scFct} {HTML}{1010FF}
\definecolor{scType}{HTML}{228B22}
\definecolor{scVar} {HTML}{A45936}
\definecolor{scComm}{HTML}{B32525}
\definecolor{scObj} {HTML}{008D92}
\definecolor{scStr} {HTML}{952952}

\lstset{
language=scala,
basicstyle=\small\ttfamily,
columns=flexible,
%texcsstyle=*\bf\color{blue},
%numbers=left,
%breaklines=true,
keywordstyle=\color{scKW},
stringstyle=\color{scStr},
showstringspaces=false,
commentstyle=\color{scComm},
%otherkeywords={$},
%frame=leftline,
%backgroundcolor=\color{lightgrey},
%escapeinside=||
}


%% Define _s_cala commands
\newcommand{\sK}[1]{{\color{scKW} #1}}
\newcommand{\sF}[1]{{\color{scFct} #1}}
\newcommand{\sV}[1]{{\color{scVar} #1}}
\newcommand{\sT}[1]{{\color{scType} #1}}
\newcommand{\sC}[1]{{\color{scComm} #1}}
\newcommand{\sO}[1]{{\color{scObj} #1}}
\newcommand{\sS}[1]{{\color{scStr} #1}}
\newcommand{\sH}[1]{{\color{white} #1}}
\newcommand{\sN}[1]{{\color{black} #1}}

%% Define other commands
%%\newcommand<>{\strike}[1]{\alt#2{\sout{#1}}{#1}}

%%% File icons
\newcommand{\scalaFile}{\includegraphics{icons/files/scala}}
\newcommand{\scalaFiles}[1][1]{\includegraphics[scale=#1]{icons/files/scala_}}
\newcommand{\jsFile}[1][1]{\includegraphics[scale=#1]{icons/files/js}}
\newcommand{\classFiles}{\includegraphics{icons/files/class_}}
\newcommand{\sjsirFiles}{\includegraphics{icons/files/sjsir_}}

\newcommand{\packageIcon}{\includegraphics{icons/files/package}}

%%% Component icons
\newcommand{\scalajsc}{\includegraphics{icons/components/scalajsc}}
\newcommand{\scalajsld}[1][1]{\includegraphics[scale=#1]{icons/components/scalajsld}}
\newcommand{\scalac}{\includegraphics{icons/components/scalac}}
\newcommand{\javaVM}{\includegraphics{icons/components/jvm}}

\setbeamercovered{transparent}
\setbeamertemplate{navigation symbols}

% Frame number on page
\setbeamertemplate{footline}{\makebox[0.98\paperwidth][r]{\large \raisebox{1.2ex}{\insertframenumber}}}

\title{The Scala.js Compilation Pipeline}
\author{Tobias Schlatter}
\date{August 15, 2015}

\begin{document}

\begin{frame}
  \begin{center}
    \visible<2>{\Large The Scala.js Compilation Pipeline}

    \vspace{1cm}

    \begin{tikzpicture}[->,thick]
      \node (scala) at (0,0) {\scalaFiles[1.2]};
      \node (js) at (8,0) {\jsFile[1.2]};
      \node (scalajs) at (4,0) {\scalajsld[1.5]};

      \draw (scala) -- (scalajs);
      \draw (scalajs) -- (js);
    \end{tikzpicture}

    \vspace{1cm}

    \visible<2>{\Large Tobias Schlatter -- \texttt{@gzm0}}
  \end{center}
\end{frame}

\section*{Overview}

\begin{frame}
  \frametitle{Contents}

  \tableofcontents
\end{frame}

\section{A View From Above}

\begin{frame}
  \frametitle{Scala JVM Pipeline}

  \begin{center}
    \begin{tikzpicture}[->,thick]
      \useasboundingbox (0,-1) rectangle (10,5);

      % Top pipeline
      \node (scala1) at (0,4) {\scalaFiles};
      \node (scalac1) at (2.5,4) {\scalac};
      \node (class1) at (5.5,4) {\classFiles};
      \node<2-> at (5,4.6) {\packageIcon};

      \draw (scala1) -- (scalac1);
      \draw (scalac1) -- (class1);

      % Bottom pipeline
      \node<3-> (scala2) at (0,0) {\scalaFiles};
      \node<3-> (scalac2) at (2.5,0) {\scalac};
      \node<3-> (class2) at (5.5,0) {\classFiles};
      \node<3-> at (5, .6) {\packageIcon};

      \draw<3-> (scala2) -- (scalac2);
      \draw<3-> (scalac2) -- (class2);

      % JVM and inputs
      \node (jvm) at (9,2) {\javaVM};

      \draw (class1) -- (jvm);
      \draw<3-> (class2) -- (jvm);

      % Compilation symbols
      \draw<4-> (class1) -- (scalac2);
    \end{tikzpicture}
  \end{center}
\end{frame}

\begin{frame}
  \frametitle{Scala.js Pipeline}

  \begin{center}
    \begin{tikzpicture}[->,thick]
      \useasboundingbox (0,-1) rectangle (10,5);

      % Top pipeline
      \node (scala1) at (0,4) {\scalaFiles};
      \node (scalajsc1) at (2.5,4) {\scalajsc};
      \node<1> (sjsir1) at (5.5,4) {\sjsirFiles};
      \node<2-> (sjsir1) at (5.5,4.7) {\sjsirFiles};
      \node<2-> (class1) at (5.5,3.3) {\classFiles};
      \node<4-> at (5,4) {\packageIcon};

      \draw (scala1) -- (scalajsc1);
      \draw (scalajsc1) -- (class1);
      \draw (scalajsc1) -- (sjsir1);

      % Bottom pipeline
      \node (scala2) at (0,0) {\scalaFiles};
      \node (scalajsc2) at (2.5,0) {\scalajsc};
      \node<1> (sjsir2) at (5.5,0) {\sjsirFiles};
      \node<2-> (sjsir2) at (5.5,.7) {\sjsirFiles};
      \node<2-> (class2) at (5.5,-.7) {\classFiles};
      \node<4-> at (5,0) {\packageIcon};

      \draw (scala2) -- (scalajsc2);
      \draw (scalajsc2) -- (class2);
      \draw (scalajsc2) -- (sjsir2);

      % Linker and JS file
      \node (scalajsld) at (9,3) {\scalajsld};
      \node (js) at (9,.5) {\jsFile};

      \draw (sjsir1) -- (scalajsld);
      \draw (sjsir2) -- (scalajsld);

      \draw (scalajsld) -- (js);

      % Compilation symbols
      \draw<3-> (class1) -- (scalajsc2);
    \end{tikzpicture}
  \end{center}
\end{frame}

\section{Scala.js Compiler}

\begin{frame}
  \frametitle{Phases of the Scala.js Compiler}

  \begin{columns}[t]
    \column{.5\textwidth}
    \begin{alltt}
      parser\\
      namer\\
      packageobjects\\
      typer\\
      \alert<2>{jsinterop\\}
      patmat\\
      superaccessors\\
      extmethods\\
      pickler\\
      refchecks\\
      uncurry\\
      tailcalls\\
      specialize\\
    \end{alltt}

    \column{.5\textwidth}
    \begin{alltt}
      explicitouter\\
      erasure\\
      posterasure\\
      lazyvals\\
      lambdalift\\
      constructors\\
      flatten\\
      mixin\\
      \alert<2>{jscode\\}
      cleanup\\
      delambdafy\\
      icode\\
      jvm\\
      terminal
    \end{alltt}
  \end{columns}
\end{frame}

\begin{frame}
  \frametitle{Phases of the Scala.js Compiler}
  \framesubtitle{Simplified}

  \begin{center}
    \begin{tikzpicture}[->,thick,
      phase/.style={
        draw,
        rectangle, rounded corners = 9pt,
        text width=2cm,
        text depth=.9ex,
        text height=.9em,
        text centered}
      ]
      \useasboundingbox (0,-1) rectangle (8,4);

      \node (scala) at (1,4) {\scalaFiles};
      \node (inclass) at (7,4) {\classFiles};

      \node[phase] (frontend) at (4, 4) {\texttt{typer}};

      \node[phase] (jsinterop) at (4, 2.5) {\texttt{jsinterop}};
      \node<2> at (2.9, 2.8) {\scalajsld[0.35]};

      \node[phase] (scalac) at (4, 1) {\texttt{scalac}};

      \node[phase] (jscode) at (1, 0) {\texttt{jscode}};
      \node<2> at (-.1, 0.3) {\scalajsld[0.35]};

      \node[phase] (jvm) at (7, 0) {\texttt{jvm}};

      \node (sjsir) at (1, -1.5) {\sjsirFiles};
      \node (class) at (7, -1.5) {\classFiles};

      \draw (scala) -- (frontend);
      \draw[dashed] (inclass) -- (frontend);
      \draw (frontend) -- (jsinterop);
      \draw (jsinterop) -- (scalac);
      \draw (scalac) -- (jscode);
      \draw (scalac) -- (jvm);
      \draw (jscode) -- (sjsir);
      \draw (jvm) -- (class);
    \end{tikzpicture}
  \end{center}
\end{frame}

\begin{frame}
  \frametitle{Scala.js Compiler Output: The IR}
  \framesubtitle{Parts identical to JVM bytecode}

  \begin{block}<+->{Classes}
    \begin{itemize}
    \item Single class, multi interface inheritance
    \item No nested classes
    \end{itemize}
  \end{block}

  \begin{block}<+->{Interfaces}
    \begin{itemize}
    \item No implementations / default methods (yet)
    \end{itemize}
  \end{block}

  \begin{block}<+->{Types}
    \begin{itemize}
    \item Primitive types (\texttt{int}, \texttt{long}, \ldots)
    \item Class types (\texttt{my.package.Foo}, \ldots)
    \item Array types (\texttt{int[]}, \texttt{Foo[]}, \ldots)
    \item No generics
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \frametitle{Scala.js IR}
  \framesubtitle{Parts different from JVM bytecode}

  \begin{block}<+->{Types}
    \begin{itemize}
    \item String type
    \end{itemize}
  \end{block}

  \begin{block}<+->{Classes}
    \begin{itemize}
    \item Overloading via name mangling
    \item JavaScript methods (aka Exports)
    \end{itemize}
  \end{block}

  \begin{block}<+->{Operations}
    \begin{itemize}
    \item<-4> AST form
    \item<-4> Statements in expression position
    \item<-5> JavaScript operations
    \end{itemize}
  \end{block}
\end{frame}


\begin{frame}[fragile]
  \frametitle{Scala.js Compiler -- Overloads}

  \begin{block}{Scala Source Code}
    \begin{lstlisting}[gobble=6]
      class Overloads {
        def foo(x: Int): Int = 2 * x
        def foo(x: Int, y: Seq[Int]): Int = x + y.length
      }
    \end{lstlisting}
  \end{block}

  \pause

  \begin{block}{Scala.js IR}
    \begin{lstlisting}[gobble=6]
      class LOverloads extends O {
        def foo__I__I(x: int): int = (2 *[int] x)
        def foo__I__sc_Seq__I(x: int, y: sc_Seq): int = {
          (x +[int] y.length__I())
        }
      }
    \end{lstlisting}
  \end{block}

\end{frame}

\begin{frame}[fragile]
  \frametitle{Scala.js Compiler -- Calling JavaScript}

  \begin{block}{Scala Source Code}
    \begin{overprint}
      \onslide<1-2>
      \begin{lstlisting}[gobble=8]
        val jsDate: js.Date = new js.Date()
        val javaDate: java.util.Date = new java.util.Date()

        jsDate.getMilliseconds
        javaDate.getTime
      \end{lstlisting}

      \onslide<3>
      \begin{lstlisting}[gobble=8]
        class Date extends js.Object {
          def getMilliseconds(): Int = js.native
        }
        val jsDate: js.Date = new js.Date()
        jsDate.getMilliseconds
      \end{lstlisting}
    \end{overprint}
  \end{block}

  \pause

  \begin{block}{Scala.js IR}
    \begin{lstlisting}[gobble=6]
      val jsDate: any = new (<envinfo>["global"]["Date"])();
      val javaDate: ju_Date = new ju_Date().init___();

      jsDate["getMilliseconds"]();
      javaDate.getTime__J()
    \end{lstlisting}
  \end{block}

\end{frame}

\begin{frame}[fragile]
  \frametitle{Scala.js Compiler -- Exports}

  \begin{block}{Scala Source Code}
    \begin{lstlisting}[gobble=6]
      class Exported {
        @JSExport("foo")
        def more(x: Int): Int = x + 2
        @JSExport
        def foo(x: String): String = "foo" + x
      }
    \end{lstlisting}
  \end{block}

  \pause

  \begin{block}{After \texttt{jsinterop}}
    \begin{lstlisting}[gobble=6]
      class Exported {
        def more(x: Int): Int = x + 2
        def foo(x: String): String = "foo" + x

        // Generated by jsinterop
        def $$js$exported$meth$foo(x: Int): Any = more(x)
        def $$js$exported$meth$foo(x: String): Any = foo(x)
      }
    \end{lstlisting}
  \end{block}

\end{frame}

\begin{frame}[fragile]
  \frametitle{Scala.js Compiler -- Exports}

  \begin{lstlisting}[gobble=4]
    class LExported extends O {
      def more__I__I(x: int): int = (x +[int] 2)
      def foo__T__T(x: T): T = ("foo" +[string] x)
      def $$js$exported$meth$foo__I__O(x: int): any = more__I__I(x)
      def $$js$exported$meth$foo__T__O(x: T): any = foo__T__T(x)
      def "foo"(arg$1: any): any = {
        if (arg$1.isInstanceOf[jl_Integer]) {
          val prep0: int = arg$1.asInstanceOf[I];
          this.$$js$exported$meth$foo__I__O(prep0)
        } else if (arg$1.isInstanceOf[T]) {
          val prep0: T = arg$1.asInstanceOf[T];
          this.$$js$exported$meth$foo__T__O(prep0)
        } else {
          throw "No matching overload"
        }
      }
    }
  \end{lstlisting}
  %$ // fix syntax highlighting

\end{frame}

\section{Scala.js Linker}

\begin{frame}
  \frametitle{Phases of the Scala.js Linker}

  \begin{center}
    \begin{tikzpicture}[->,thick,
      phase/.style={
        draw,
        rectangle, rounded corners = 9pt,
        text width=2cm,
        text depth=.9ex,
        text height=.9em,
        text centered}
      ]

      \node (sjsir) at (0, 6) {\sjsirFiles};

      \node[phase] (linker) at (3, 6) {Linker};

      \node[phase,dashed] (irchecker) at (5.5, 5) {IR Checker};

      \node[phase] (optimizer) at (3, 4.5) {Optimizer};
      \node[phase] (refiner) at (3, 3) {Refiner};
      \node[phase] (desugar) at (3, 1.5) {Desugar};

      \node[phase,dashed] (closure) at (3, 0) {Closure};

      \node (fastopt) at (7,1.5) {\jsFile};
      \node (fullopt) at (7,0) {\jsFile[0.6]};

      \draw[dashed] (linker) to [out=-90,in=180,right] (irchecker);
      \draw (sjsir) -- (linker);
      \draw (linker) -- (optimizer);
      \draw (optimizer) -- (refiner);
      \draw (refiner) -- (desugar);
      \draw (desugar) -- node[above] {fastOpt} (fastopt);

      \draw[dashed] (desugar) -- (closure);
      \draw[dashed] (closure) -- node[above] {fullOpt} (fullopt);

    \end{tikzpicture}
  \end{center}

\end{frame}

\section*{Things I Shamelessly Omitted}

\begin{frame}
  \frametitle{Things I Shamelessly Omitted}

  \begin{itemize}
  \item Hijacked Classes
  \item \texttt{scala.Enumeration}
  \item Instance tests for raw JavaScript types
  \item IR Helper types (Undefined, Null, Nothing, NoType, Record-types)
  \item IR Labeled Blocks (pattern matches, tailrec methods)
  \item IR Modules (objects)
  \item Exporting classes (constructors)
  \item Reflective Calls
  \end{itemize}
\end{frame}

\end{document}