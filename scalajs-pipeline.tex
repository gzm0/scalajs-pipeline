\documentclass{beamer}

\usepackage[utf8]{inputenc}

\usepackage{alltt}
\usepackage{amssymb}
%\usepackage{xcolor}
%\usepackage[overlay,absolute]{textpos}
%\usepackage[normalem]{ulem}

\usepackage{tikz}
\usepackage{tkz-berge}

%%%% Colors for source highlighting
%%\definecolor{scKW}  {HTML}{AA37F2}
%%\definecolor{scFct} {HTML}{1010FF}
%%\definecolor{scType}{HTML}{228B22}
%%\definecolor{scVar} {HTML}{A45936}
%%\definecolor{scComm}{HTML}{B32525}
%%
%%%% Define _s_cala commands
%%\newcommand{\sK}[1]{{\color{scKW} #1}}
%%\newcommand{\sF}[1]{{\color{scFct} #1}}
%%\newcommand{\sV}[1]{{\color{scVar} #1}}
%%\newcommand{\sT}[1]{{\color{scType} #1}}
%%\newcommand{\sC}[1]{{\color{scComm} #1}}
%%\newcommand{\sH}[1]{{\color{white} #1}}
%%\newcommand{\sN}[1]{{\color{black} #1}}
%%\newcommand{\sS}{\vspace{0.8mm}}

%% Define other commands
%%\newcommand<>{\strike}[1]{\alt#2{\sout{#1}}{#1}}

%%% File icons
\newcommand{\scalaFile}{\includegraphics{icons/files/scala}}
\newcommand{\scalaFiles}[1][1]{\includegraphics[scale=#1]{icons/files/scala_}}
\newcommand{\jsFile}[1][1]{\includegraphics[scale=#1]{icons/files/js}}
\newcommand{\classFiles}{\includegraphics{icons/files/class_}}
\newcommand{\sjsirFiles}{\includegraphics{icons/files/sjsir_}}

\newcommand{\packageIcon}{\includegraphics{icons/files/package}}

%%% Component icons
\newcommand{\scalajsc}{\includegraphics{icons/components/scalajsc}}
\newcommand{\scalajsld}[1][1]{\includegraphics[scale=#1]{icons/components/scalajsld}}
\newcommand{\scalac}{\includegraphics{icons/components/scalac}}
\newcommand{\javaVM}{\includegraphics{icons/components/jvm}}

\setbeamercovered{transparent}
\setbeamertemplate{navigation symbols}

% Frame number on page
\setbeamertemplate{footline}{\makebox[0.98\paperwidth][r]{\large \raisebox{1.2ex}{\insertframenumber}}}

\newcommand{\emptyFile}{\includegraphics[width=1.5cm]{empty-icon}}

\title{The Scala.js Compilation Pipeline}
\author{Tobias Schlatter}
\date{August 15, 2015}

\begin{document}

\begin{frame}
  \begin{center}
    \visible<2>{\Large The Scala.js Compilation Pipeline}

    \vspace{1cm}

    \begin{tikzpicture}
      \node (scala) at (0,0) {\scalaFiles[1.2]};
      \node (js) at (8,0) {\jsFile[1.2]};
      \node (scalajs) at (4,0) {\scalajsld[1.5]};

      \draw[->,thick] (scala) -- (scalajs);
      \draw[->,thick] (scalajs) -- (js);
    \end{tikzpicture}

    \vspace{1cm}

    \visible<2>{\Large Tobias Schlatter -- \texttt{@gzm0}}
  \end{center}
\end{frame}

\section*{Overview}

\begin{frame}
  \frametitle{Contents}

  \tableofcontents
\end{frame}

\section{A View From Above}
\subsection{Scala JVM Pipeline}

\begin{frame}
  \frametitle{Scala JVM Pipeline}

  \begin{center}
    \begin{tikzpicture}[->,thick]
      \useasboundingbox (0,-1) rectangle (10,5);

      % Top pipeline
      \node (scala1) at (0,4) {\scalaFiles};
      \node (scalac1) at (2.5,4) {\scalac};
      \node (class1) at (5.5,4) {\classFiles};
      \node<2-> at (5,4.6) {\packageIcon};

      \draw (scala1) -- (scalac1);
      \draw (scalac1) -- (class1);

      % Bottom pipeline
      \node<3-> (scala2) at (0,0) {\scalaFiles};
      \node<3-> (scalac2) at (2.5,0) {\scalac};
      \node<3-> (class2) at (5.5,0) {\classFiles};
      \node<3-> at (5, .6) {\packageIcon};

      \draw<3-> (scala2) -- (scalac2);
      \draw<3-> (scalac2) -- (class2);

      % JVM and inputs
      \node (jvm) at (9,2) {\javaVM};

      \draw (class1) -- (jvm);
      \draw<3-> (class2) -- (jvm);

      % Compilation symbols
      \draw<4-> (class1) -- (scalac2);
    \end{tikzpicture}
  \end{center}
\end{frame}

\subsection{Scala.js Pipeline}
\begin{frame}
  \frametitle{Scala.js Pipeline}

  \begin{center}
    \begin{tikzpicture}[->,thick]
      \useasboundingbox (0,-1) rectangle (10,5);

      % Top pipeline
      \node (scala1) at (0,4) {\scalaFiles};
      \node (scalajsc1) at (2.5,4) {\scalajsc};
      \node<1> (sjsir1) at (5.5,4) {\sjsirFiles};
      \node<2-> (sjsir1) at (5.5,4.7) {\sjsirFiles};
      \node<2-> (class1) at (5.5,3.3) {\classFiles};
      \node<4-> at (5,4) {\packageIcon};

      \draw (scala1) -- (scalajsc1);
      \draw (scalajsc1) -- (class1);
      \draw (scalajsc1) -- (sjsir1);

      % Bottom pipeline
      \node (scala2) at (0,0) {\scalaFiles};
      \node (scalajsc2) at (2.5,0) {\scalajsc};
      \node<1> (sjsir2) at (5.5,0) {\sjsirFiles};
      \node<2-> (sjsir2) at (5.5,.7) {\sjsirFiles};
      \node<2-> (class2) at (5.5,-.7) {\classFiles};
      \node<4-> at (5,0) {\packageIcon};

      \draw (scala2) -- (scalajsc2);
      \draw (scalajsc2) -- (class2);
      \draw (scalajsc2) -- (sjsir2);

      % Linker and JS file
      \node (scalajsld) at (9,3) {\scalajsld};
      \node (js) at (9,.5) {\jsFile};

      \draw (sjsir1) -- (scalajsld);
      \draw (sjsir2) -- (scalajsld);

      \draw (scalajsld) -- (js);

      % Compilation symbols
      \draw<3-> (class1) -- (scalajsc2);
    \end{tikzpicture}
  \end{center}
\end{frame}

\section{Scala.js IR}

\begin{frame}
  \frametitle{Scala.js IR}
  \framesubtitle{The copied part}

  \begin{block}<+->{Classes}
    \begin{itemize}
    \item Single class, multi interface inheritance
    \item No nested classes
    \end{itemize}
  \end{block}

  \begin{block}<+->{Interfaces}
    \begin{itemize}
    \item No implementations / default methods (yet)
    \end{itemize}
  \end{block}

  \begin{block}<+->{Types}
    \begin{itemize}
    \item Primitive types (\texttt{int}, \texttt{long}, \ldots)
    \item Class types (\texttt{my.package.Foo}, \ldots)
    \item Array types (\texttt{int[]}, \texttt{Foo[]}, \ldots)
    \item No generics
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \frametitle{Scala.js IR}
  \framesubtitle{The different part}

  \begin{block}<+->{Modules (aka Objects)}
  \end{block}

  \begin{block}<+->{Types}
    \begin{itemize}
    \item String type
    \end{itemize}
  \end{block}

  \begin{block}<+->{Operations}
    \begin{itemize}
    \item AST form
    \item Statements in expression position
    \item JavaScript operations
    \end{itemize}
  \end{block}
\end{frame}

\section{Scala.js Compiler}

\begin{frame}
  \frametitle{Phases of the Scala.js Compiler}

  \begin{columns}[t]
    \column{.5\textwidth}
    \begin{alltt}
      parser\\
      namer\\
      packageobjects\\
      typer\\
      \alert<2>{jsinterop\\}
      patmat\\
      superaccessors\\
      extmethods\\
      pickler\\
      refchecks\\
      uncurry\\
      tailcalls\\
      specialize\\
    \end{alltt}

    \column{.5\textwidth}
    \begin{alltt}
      explicitouter\\
      erasure\\
      posterasure\\
      lazyvals\\
      lambdalift\\
      constructors\\
      flatten\\
      mixin\\
      \alert<2>{jscode\\}
      cleanup\\
      delambdafy\\
      icode\\
      jvm\\
      terminal
    \end{alltt}
  \end{columns}
\end{frame}

\begin{frame}
  \frametitle{Phases of the Scala.js Compiler}
  \framesubtitle{Simplified}

  \begin{center}
    \begin{tikzpicture}[->,thick,
      phase/.style={
        draw,
        rectangle, rounded corners = 9pt,
        text width=2cm,
        text depth=.9ex,
        text height=.9em,
        text centered}
      ]

      \node (scala) at (1,4) {\scalaFiles};

      \node[phase] (frontend) at (4, 4) {\texttt{typer}};

      \node[phase] (jsinterop) at (4, 2.5) {\texttt{jsinterop}};
      \node[phase] (scalac) at (4, 1) {\texttt{scalac}};

      \node[phase] (jscode) at (1, 0) {\texttt{jscode}};
      \node[phase] (jvm) at (7, 0) {\texttt{jvm}};

      \node (sjsir) at (1, -1.5) {\sjsirFiles};
      \node (class) at (7, -1.5) {\classFiles};

      \draw (scala) -- (frontend);
      \draw (frontend) -- (jsinterop);
      \draw (jsinterop) -- (scalac);
      \draw (scalac) -- (jscode);
      \draw (scalac) -- (jvm);
      \draw (jscode) -- (sjsir);
      \draw (jvm) -- (class);
    \end{tikzpicture}
  \end{center}
\end{frame}

\begin{frame}
  \frametitle{Scala.js Compiler -- Duties}

  \begin{block}<-2>{JVM like parts \only<2->{\checkmark}}
    \begin{itemize}
    \item Classes
    \item Interfaces
    \item Types
    \end{itemize}
  \end{block}

  \begin{block}<-7>{Parts different from the JVM}
    \begin{itemize}
    \item<-6> Modules (aka objects) \only<4->{\checkmark}
    \item String type
    \item<-6> AST form \only<5->{\checkmark}
    \item<-6> Statements in expression position \only<6->{\checkmark}
    \item JavaScript operations
    \end{itemize}
  \end{block}

\end{frame}

\section{Scala.js Linker}

\begin{frame}
  \frametitle{Phases of the Scala.js Linker}

  \begin{itemize}
  \item Linking (alive code inclusion)
  \item Optimizer
  \item Refiner (dead code elimination)
  \item Emitter / Desugarer
  \item Google Closure Compiler
  \end{itemize}

\end{frame}

\section*{Things I Shamelessly Omitted}

\begin{frame}
  \frametitle{Things I Shamelessly Omitted}

  \begin{itemize}
  \item Hijacked Classes
  \item \texttt{scala.Enumeration}
  \item Instance tests for raw JavaScript types
  \item IR Helper types (Undefined, Null, Nothing, NoType, Record-types)
  \item IR Labeled Blocks
  \item Reflective Calls
  \end{itemize}
\end{frame}

\end{document}